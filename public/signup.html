<!DOCTYPE html>
<html>
<head>
	<title>Precision Autonomy</title>
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
		<script type="text/javascript" src="js/lib/braintree.js"></script>
	  <style type="text/css">
	  	body{
	  		background-color: #F6F6F6;
	  	}
	  	@media only screen and (max-width: 1026px) {
    	#extratop {
        	display: none;
    		}
		}
		.hidden{
			display:none;
		}
		#paymentArea, #optionArea{
			position:relative;
		}
		#backToForm, #backToOption{
			position:absolute;
			top:70px;
			left:10px;
			font-size:40px;
		}
		.help {
			position:absolute;
			top:10px;
			right:10px;
			width:40px;
			cursor:pointer;
		}
		.selection-summary label {
			color:black;
			font-size:16px;
		}
		.selection-summary span {
			font-size:12px;
		}
	  </style>
</head>
<body>
<div id="extratop" class="row col sm0">

</div>
<div id="formArea" class="row">
	<div class="col s12 m3 l4 white-text">.</div>
	<form id="formInfo" class="col s12 m6 l4">
		<div class="card col l12 m12 s12 grey lighten-3">
				<img class="container" style="width:100%;padding:70px" src="images/logo.png">
				<a href="https://precision-autonomy.helpshift.com" target="_blank"><img class="help" src="images/help.png"></a>
				<div class="input-field col s6 m6 l6">
        	<input id="first_name" type="text" name="first_name">
       		<label for="first_name" class="">First Name</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="last_name" type="text" name="last_name">
       		<label for="last_name" class="">Last Name</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="phone" type="text" name="phone">
       		<label for="phone" class="">Phone</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="callsign" type="text" name="callsign">
       		<label for="callsign" class="" >Callsign</label>
      	</div>
				<div class="input-field col s6 m6 l6">
					<select name="country" id="country" onchange="updateState();">
						<option>USA</option>
						<option>Australia</option>
					</select>
      	</div>
				<div class="input-field col s6 m6 l6">
					<select name="state" id="state">
					</select>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="address" type="text" name="address">
       		<label for="address" class="">Address</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="city" type="text" name="city">
       		<label for="city" class="">City</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="zipcode" type="text" name="zipcode">
       		<label for="zipcode" class="">Zipcode</label>
      	</div>

      	<div class="input-field col s6 m6 l6">
			  	<select placeholder="Role" name="role" id="role">
				    <option value="" disabled selected>Role</option>
						<option value="Flight Operator">Flight Operator</option>
				    <option value="Pilot in Charge">Pilot in Charge</option>
			  	</select>
  			</div>
  			<div style="clear:both"></div>
				<div class="input-field col s6 m6 l6">
        	<input id="email" type="text" name="email">
       		<label for="email" class="">Email *</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="confirm_email" type="email" name="confirm_email" required>
       		<label for="confirm_email" class="">Confirm Email</label>
      	</div>

				<div class="input-field col s6 m6 l6">
        	<input id="password" type="password" name="password">
       		<label for="password" class="">Password *</label>
      	</div>
				<div class="input-field col s6 m6 l6">
        	<input id="password_confirmation" name="password_confirmation" type="password">
       		<label for="password_confirmation" class="">Confirm Password</label>
      	</div>
      	<div style="clear:both;height:20px" ></div>
				<div class="col s6 m6 l6">
      		<a class="waves-effect waves-light btn col s12 m12 l12 white" style="color:black" href="/">cancel</a>
      	</div>
				<div class="col s6 m6 l6">
      		<a class="waves-effect waves-light btn col s12 m12 l12 white" style="color:black" id="toOption">next&gt</a>
      	</div>
      	<div style="clear:both;height:30px" ></div>
			</div>
  	</form>
	<div class="col s12 m3 l4"></div>
</div>

<div id="optionArea" class="row hidden">
	<div class="col s12 m3 l4 white-text">.</div>
	<form id="formInfo" class="col s12 m6 l4">
		<div class="card col l12 m12 s12 grey lighten-3">
			<a class="waves-effect waves-light" id="backToForm" > ❮ </a>
			<img class="container" style="width:100%;padding:70px" src="images/logo.png">
			<a href="https://precision-autonomy.helpshift.com" target="_blank"><img class="help" src="images/help.png"></a>

			<div class="pa-plans">
					<h5 class="center" style="margin:0px;">Flight Plans</h5>
					<div class="pa-plans-list">

					</div><br>
			</div>

      <div style="clear:both;height:20px" ></div>
			<div class="col s6 m6 l6">
    		<a class="waves-effect waves-light btn col s12 m12 l12 white" style="color:black" href="/">cancel</a>
    	</div>
			<div class="col s6 m6 l6">
    		<a class="waves-effect waves-light btn col s12 m12 l12 white" style="color:black" id="toPayment">next&gt</a>
    	</div>
    	<div style="clear:both;height:30px" ></div>
		</div>
	</form>
	<div class="col s12 m3 l4"></div>
</div>

<div id="paymentArea" class="row hidden">
	<div class="col s12 m3 l4 white-text">.</div>
	<div class="col s12 m6 l4">
		<div class="card col l12 m12 s12 grey lighten-3" style="text-align:center">
			<img class="container" style="width:100%; padding:70px" src="images/logo.png">
			<a href="https://precision-autonomy.helpshift.com" target="_blank"><img class="help" src="images/help.png"></a>
			<div class="row">
				<div class="input-field col s3 m3 l3">
					<input type="radio" id="payment_type_visa" name="payment_type" value="visa" checked/>
					<label for="payment_type_visa"><img src="images/Visa-40.png"></label>
				</div>
				<div class="input-field col s3 m3 l3">
					<input type="radio" id="payment_type_master" name="payment_type" value="master"/>
					<label for="payment_type_master"><img src="images/Mastercard-40.png"></label>
				</div>
				<div class="input-field col s3 m3 l3">
					<input type="radio" id="payment_type_american" name="payment_type" value="american"/>
					<label for="payment_type_american"><img src="images/Amex-40.png"></label>
				</div>
				<div class="input-field col s3 m3 l3">
					<input type="radio" id="payment_type_discover" name="payment_type" value="discover"/>
					<label for="payment_type_discover"><img src="images/Discover-40.png"></label>
				</div>
			</div>
			<div class="row">
					<div class="input-field col s8 m8 l8">
						<input id="credit_card" type="number" name="credit_card">
						<label for="credit_card" class="">Credit Card Number</label>
					</div>
					<div class="input-field col s4 m4 l4">
						<input id="security_code" type="number" name="security_code">
						<label for="security_code" class="">Security Code</label>
					</div>
			</div>
			<div class="row">
				<div class="input-field col s3 m3 l3">
					<select name="expire_month" id="expire_month">
				    <option value="" disabled selected>Month</option>
						<option value="1">1</option>
				    <option value="2">2</option>
						<option value="3">3</option>
				    <option value="4">4</option>
						<option value="5">5</option>
				    <option value="6">6</option>
						<option value="7">7</option>
				    <option value="8">8</option>
						<option value="9">9</option>
				    <option value="10">10</option>
						<option value="11">11</option>
				    <option value="12">12</option>
			  	</select>
				</div>
				<div class="input-field col s3 m3 l3">
					<select name="expire_year" id="expire_year">
				    <option value="" disabled selected>Year</option>
						<option value="2017">2017</option>
				    <option value="2018">2018</option>
						<option value="2019">2019</option>
						<option value="2020">2020</option>
						<option value="2021">2021</option>
						<option value="2022">2022</option>
			  	</select>
				</div>
			</div>
			<h5>Selection Summary</h5>
			<div class="selection-summary">

			</div>
			<a class="waves-effect waves-light" id="backToOption" > ❮ </a>
			Submit is agreement with <a href="#">T&C</a> and <a href="#">Privacy policy</a>
      	<div style="clear:both;height:20px" ></div>
				<div class="col s6 m6 l6">
      		<a class="waves-effect waves-light btn col s12 m12 l12 white" style="color:black" href="/">cancel</a>
      	</div>
				<div class="col s6 m6 l6">
      		<a class="waves-effect waves-light btn col s12 m12 l12 white" style="color:black" id="submitBtn">submit</a>
      	</div>
      	<div style="clear:both;height:30px" ></div>
  	</div>
	</div>

	<div class="col s12 m3 l4"></div>

</div>


<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
<script type="text/javascript">
	var plans = [];
	var state = {
			"USA":[
			"Alabama",
			"Alaska",
			"American Samoa",
			"Arizona",
			"Arkansas",
			"California",
			"Colorado",
			"Connecticut",
			"Delaware",
			"District Of Columbia",
			"Federated States Of Micronesia",
			"Florida",
			"Georgia",
			"Guam",
			"Hawaii",
			"Idaho",
			"Illinois",
			"Indiana",
			"Iowa",
			"Kansas",
			"Kentucky",
			"Louisiana",
			"Maine",
			"Marshall Islands",
			"Maryland",
			"Massachusetts",
			"Michigan",
			"Minnesota",
			"Mississippi",
			"Missouri",
			"Montana",
			"Nebraska",
			"Nevada",
			"New Hampshire",
			"New Jersey",
			"New Mexico",
			"New York",
			"North Carolina",
			"North Dakota",
			"Northern Mariana Islands",
			"Ohio",
			"Oklahoma",
			"Oregon",
			"Palau",
			"Pennsylvania",
			"Puerto Rico",
			"Rhode Island",
			"South Carolina",
			"South Dakota",
			"Tennessee",
			"Texas",
			"Utah",
			"Vermont",
			"Virgin Islands",
			"Virginia",
			"Washington",
			"West Virginia",
			"Wisconsin",
			"Wyoming"
			],
			"Australia":
			["New South Wales",
			"Queensland",
			"South Australia",
			"Tasmania",
			"Victoria",
			"Western Australia",
			"Australian Capital Territory",
			"Northern Territory"]
	};
	$("select").material_select();

	$.post('api/v1/braintree/plans', function(result) {
		if(result.success) {
			$(".pa-plans").show();
			$(".pa-plans-list").html("");
			if(result.plans.length > 0) {
				var content = "";
				plans = result.plans;
				for(var i = 0; i < result.plans.length; i++) {
						content += '<div class="row" style="margin:0px;">'+
								'<div class="input-field col s6 m6 l6">'+
									'<input type="radio" id="'+result.plans[i].id+'" name="pa-plans" value="'+result.plans[i].id+'" '+ (i==0?'checked':'' )+'/>'+
									'<label for="'+result.plans[i].id+'">'+result.plans[i].name+'</label>'+
								'</div>'+
								'<div class="input-field col s6 m6 l6">'+
									'<label>$'+result.plans[i].price+' / Month</label>'+
								'</div>'+
						'</div>';
				}

				$(".pa-plans-list").html(content);
			} else {

			}
		} else {
			$(".pa-plans").hide();
		}
	});

	$("#submitBtn").click(function() {
		if(!$("#credit_card").val()) {
				alert("Credit Card is required field");
				return;
		}

		if(!$("#security_code").val()) {
				alert("Security Code is required field");
				return;
		}

		if(!$("#expire_year").val()) {
				alert("Expire Date is required field");
				return;
		}

		if(!$("#expire_month").val()) {
				alert("Expire Date is required field");
				return;
		}

		var data = {
			firstname: $("#first_name").val(),
			lastname: $("#last_name").val(),
			callsign: $("#callsign").val(),
			phoneNumber: $("#phone").val(),
			operator: $("#role").val(),
			password: $("#password").val(),
			email: $("#email").val(),
			country: $("#country").val(),
			zipcode: $("#zipcode").val(),
			state: $("#state").val(),
			address: $("#address").val(),
			city: $("#city").val(),
			payment_type: $("input[name='payment_type']:checked").attr("value"),
			creditCardNumber: $("#credit_card").val(),
			securityCode: $("#security_code").val(),
			expire_month: $("#expire_month").val(),
			expire_year: $("#expire_year").val(),
			pa_plans: $("input[name='pa-plans']:checked").attr("value"),
		}

		$.post('api/v1/braintree/getToken', {}, function(result) {
			var client = new braintree.api.Client({clientToken: result.client_token});
			client.tokenizeCard({
				number: data.creditCardNumber,
				expirationDate: data.expire_month+'/'+data.expire_year
			}, function (err, nonce) {
				if(err) {
						alert('Payment information is not valid');
						return;
				}
				$.post('api/v1/braintree/customer', {
						firstName: data.firstname,
						lastName: data.lastname,
						company: "company",
						email: data.email,
						phone: data.phoneNumber,
						fax: "fax",
						website: "www.google.com"
				  }, function(customer) {
						if (customer.success) {
								data.customerId = customer.customer.id
								$.post('api/v1/braintree/paymentMethod', {
										customerId: customer.customer.id,
										payment_method_nonce: nonce
									}, function(paymentMethod) {
										if(paymentMethod.success) {
												$.post('api/v1/braintree/subscription', {
														planid: data.pa_plans,
														paymentMethodToken: paymentMethod.paymentMethod.token
													}, function(result1) {
														data.subscriptionId = result1.subscription.id
														if (result1.success) {
																$.post('users/signup', data,function(result){
																	if(result=="success"){
																		 location.href ="/";
																	}
																	else{
																		// alert("Username or Password is incorrect");
																		alert("Server Error, Please try again later.");

																	}
																});
														} else {
															// implement your solution to handle payment failures
															alert('Payment Verification failed. Please type correct payment information.');
														}
												});
										}
										else {
											alert(paymentMethod.message);
										}

								});
					  } else {
					    // implement your solution to handle payment failures
					    alert('Payment Verification failed. Please type correct payment information.');
					  }
				});
				//

			});
		});



				// body...
	});

	$("#toPayment").click(function() {
		$("#formArea").addClass("hidden");
		$("#optionArea").addClass("hidden");
		$("#paymentArea").removeClass("hidden");

		$(".selection-summary").html("");

		var content="";
		//
		// if($("#pass_card").prop("checked")) {
		// 	total += 99.5
		// 	content += '<div class="row"><div class="col s6 m6 l6"><label>PASS CARD</label></div><div class="col s6 m6 l6"><label>$99.50</label></div></div>'
		// }
		// if($("#pass_insurance").prop("checked")) {
		// 	total += 5
		// 	total_month += 5
		// 	content += '<div class="row"><div class="col s6 m6 l6"><label>Pass Insurance</label><br><span>monthly charge</span></div><div class="col s6 m6 l6"><label>$5.00</label></div></div>'
		// }

		var plan_id = $("input[name='pa-plans']:checked").attr("value");
		for(var i = 0; i < plans.length; i++) {
				if(plans[i].id == plan_id) {
					content += '<div class="row"><div class="col s6 m6 l6"><label>'+plans[i].name+'</label><br><span>monthly charge</span></div><div class="col s6 m6 l6"><label>$'+plans[i].price+'</label></div></div>'
					content +='<div class="row"><div class="col s6 m6 l6"><label>Total Monthly Charges</label></div><div class="col s6 m6 l6"><label>$'+plans[i].price+'</label></div></div>'
					content +='<div class="row"><div class="col s6 m6 l6"><label>Total</label></div><div class="col s6 m6 l6"><label>$'+plans[i].price+'</label></div></div>'
					break;
				}
		}

		$(".selection-summary").html(content);
	});

	$("#toOption").click(function() {
		if(!$("#role").val()) {
				alert("Role field is required field.");
				return;
		}

		if(!$("#email").val() || !isValidEmailAddress($("#email").val())) {
				alert("Email field is required field and should be correct type.");
				return;
		}

		if(!$("#password").val() || $("#password").val().length < 6) {
				alert("Password field is required field and should be more than 6 characters.");
				return;
		}

		if($("#email").val() && $("#email").val() != $("#confirm_email").val()) {
				alert("Email and Confirm Email field should be same.");
				return;
		}

		if($("#password").val() && $("#password").val() != $("#password_confirmation").val()) {
				alert("Password and Confirm Password field should be same.");
				return;
		}

		$.get('operator/checkEmail/' + $("#email").val(), function(data){
				if(data=="success"){
						$("#formArea").addClass("hidden");
						$("#paymentArea").addClass("hidden");
						$("#optionArea").removeClass("hidden");
				}
				else{
				// alert("Username or Password is incorrect");
						$('#errorModal').openModal();

				}
		});

	});

	$("#backToOption").click(function() {
		$("#paymentArea").addClass("hidden");
		$("#formArea").addClass("hidden");
		$("#optionArea").removeClass("hidden");
	});

	$("#backToForm").click(function() {
		$("#paymentArea").addClass("hidden");
		$("#formArea").removeClass("hidden");
		$("#optionArea").addClass("hidden");
	});

	function updateState() {
		$("#state").html("");
		for(var i = 0; i < state[$("#country").val()].length; i++) {
			$("#state").append("<option>"+state[$("#country").val()][i]+"</option>")
		}
		$("#state").material_select();
	}

	function isValidEmailAddress(emailAddress) {
    var pattern = /^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;
    return pattern.test(emailAddress);
	};

	updateState();
</script>
</body>


<!-- Modal Structure -->
<div id="errorModal" class="modal">
	<div class="modal-content center">
		<img class="container" style="width: 30%;" src="images/logo.png">
		<p>Email Address is not valid. Please try use another email address.</p>
	</div>
	<div class="modal-footer">
		<a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">OK</a>
	</div>
</div>


</html>
